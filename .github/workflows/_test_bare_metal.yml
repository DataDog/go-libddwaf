name: Test (Bare Metal)
on:
  workflow_call: # This is called by test.yml

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        runs-on: [ macos-14, macos-13, macos-12, macos-11, ubuntu-22.04, ubuntu-20.04, ubuntu-latest-16-cores, windows-latest ]
        go-version: [ "1.22.0", "1.21", "1.20", "1.19" ]
        include:
          # Test with DD_APPSEC_WAF_LOG_LEVEL (only latest go, without any particular tag)
          - go-version: '1.22'
            waf-log-level: TRACE
    name: ${{ toJSON(matrix) }}
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
      - name: go test
        shell: bash
        run: ./.github/workflows/ci.sh
        env:
          DD_APPSEC_WAF_LOG_LEVEL: ${{ matrix.waf-log-level }}
